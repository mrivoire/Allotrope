<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Allotrope ‚Äì Jeu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #111;
      color: #fff;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      text-align: center;
      background: #181818;
      padding: 25px;
      border-radius: 16px;
      max-width: 420px;
      width: 90%;
    }
    h1 { margin-bottom: 12px; }
    h2 { color: #f5c242; margin-top: 0; }

    #startBtn {
      background: #f5c242;
      color: #111;
      padding: 16px 30px;
      border: none;
      border-radius: 999px;
      font-size: 1.4rem;
      cursor: pointer;
      margin-top: 30px;
      font-weight: bold;
    }

    .pointer {
      width: 0;
      height: 0;
      border-left: 14px solid transparent;
      border-right: 14px solid transparent;
      border-bottom: 24px solid #f5c242;
      margin: 12px auto;
      display: none;
    }

    #wheelCanvas {
      display: none;
      margin: 0 auto;
      background: #111;
      border-radius: 50%;
    }
    #result, #qrcode { display: none; }
  </style>
</head>

<body>
<div class="container">

  <h1>Allotrope</h1>
  <h2>üéâ Jeu du cadeau üéâ</h2>

  <!-- Bouton Start -->
  <button id="startBtn">START</button>

  <!-- √âl√©ments du jeu (se montreront apr√®s avis) -->
  <div class="pointer"></div>
  <canvas id="wheelCanvas" width="320" height="320"></canvas>

  <div id="result" style="margin-top:20px;font-size:1.2rem;"></div>

  <h3 id="qrTitle" style="margin-top:25px; display:none;">QR code pour le staff :</h3>
  <div id="qrcode"></div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {

  const startBtn = document.getElementById("startBtn");
  const wheel = document.getElementById("wheelCanvas");
  const pointer = document.querySelector(".pointer");
  const result = document.getElementById("result");
  const qrCode = document.getElementById("qrcode");
  const qrTitle = document.getElementById("qrTitle");

  // ‚úîÔ∏è Le bouton START renvoie aux consignes
  startBtn.addEventListener("click", () => {
    window.location.href = "consignes.html";
  });

  // ‚úîÔ∏è V√©rifie si un gain a d√©j√† √©t√© tir√©
  const savedPrize = localStorage.getItem("allotrope_prize_final");
  const savedUID   = localStorage.getItem("allotrope_uid_final");

  if (savedPrize && savedUID) {
    // üëâ Affiche directement le r√©sultat
    startBtn.style.display = "none";
    pointer.style.display = "block";
    wheel.style.display = "block";
    result.style.display = "block";
    qrTitle.style.display = "block";
    qrCode.style.display = "block";

    drawStaticWheel(savedPrize);
    result.innerHTML = "Vous avez gagn√© : <span style='color:#f5c242;font-weight:bold;'>" + savedPrize + "</span>";
    generateQR(savedPrize, savedUID);
    return;
  }

  // üü° Si aucun gain : c‚Äôest que l‚Äôutilisateur revient d‚Äôun avis ‚Üí on lance la roue
  if (!savedPrize && document.referrer.includes("avis.html")) {
    startBtn.style.display = "none";

    pointer.style.display = "block";
    wheel.style.display = "block";

    spinWheel();
  }

  // ---------------------------------------
  // üîµ Fonction roue statique
  // ---------------------------------------
  function drawStaticWheel(prize) {
    const prizes = [
      "Tiramisu", "Panna cotta", "Cocktail du moment",
      "Verre de vin 12 cl", "Bi√®re 25 cl", "-10% sur la note", "Un shot offert"
    ];
    const colors = ["#f5c242","#f28e2b","#e15759","#76b7b2","#59a14f","#edc948","#af7aa1"];

    const ctx = wheel.getContext("2d");
    const size = wheel.width;
    const radius = size/2;
    const sliceAngle = (2*Math.PI)/prizes.length;

    ctx.clearRect(0,0,size,size);
    ctx.save();
    ctx.translate(radius, radius);

    for (let i=0; i<prizes.length; i++) {
      const start = i * sliceAngle;
      const end = start + sliceAngle;
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.arc(0,0,radius-4,start,end);
      ctx.closePath();
      ctx.fillStyle = colors[i];
      ctx.fill();
    }
    ctx.restore();
  }

  // ---------------------------------------
  // üîµ Fonction tirage + animation
  // ---------------------------------------
  function spinWheel() {
    const prizes = [
      "Tiramisu", "Panna cotta", "Cocktail du moment",
      "Verre de vin 12 cl", "Bi√®re 25 cl", "-10% sur la note", "Un shot offert"
    ];

    const ctx = wheel.getContext("2d");
    const size = wheel.width;
    const radius = size/2;
    const sliceAngle = (2*Math.PI)/prizes.length;

    // Choix du gain
    const index = Math.floor(Math.random() * prizes.length);
    const prize = prizes[index];
    const uid = crypto.randomUUID().split("-")[0];

    localStorage.setItem("allotrope_prize_final", prize);
    localStorage.setItem("allotrope_uid_final", uid);

    // Animation
    let angle = 0;
    const finalAngle = (3*Math.PI)/2 - (index*sliceAngle + sliceAngle/2);
    const duration = 4500;
    const extra = 4 * 2 * Math.PI;
    const target = extra + finalAngle;

    const start = performance.now();

    function animate(t) {
      const elapsed = t - start;
      const q = Math.min(elapsed / duration, 1);
      const ease = 1 - Math.pow(1-q, 3);

      angle = ease * target;
      drawStaticWheel(); // Fond
      ctx.save();
      ctx.translate(radius, radius);
      ctx.rotate(angle);
      ctx.restore();

      if (q < 1) {
        requestAnimationFrame(animate);
      } else {
        result.style.display = "block";
        qrTitle.style.display = "block";
        qrCode.style.display = "block";

        result.innerHTML =
          "Vous avez gagn√© : <span style='color:#f5c242;font-weight:bold;'>" + prize + "</span>";

        generateQR(prize, uid);
      }
    }

    requestAnimationFrame(animate);
  }

  // ---------------------------------------
  // üîµ G√©n√©ration QR code
  // ---------------------------------------
  function generateQR(prize, uid) {
    qrCode.innerHTML = "";
    const base = window.location.origin + "/Allotrope/";
    const url = base + "validate.html?gain=" + encodeURIComponent(prize) + "&uid=" + uid;
    new QRCode(qrCode, { text: url, width: 140, height: 140 });
  }

});
</script>

</body>
</html>
