<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Allotrope - Roue 100% gagnante</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #111;
      color: #f8f8f8;
      text-align: center;
      margin: 0;
      padding: 20px;
    }

    canvas {
      background: #222;
      border-radius: 50%;
      margin-top: 20px;
    }

    button {
      margin-top: 20px;
      padding: 12px 22px;
      font-size: 1.2rem;
      font-weight: 700;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #f5c242;
      color: #111;
    }

    .highlight {
      color: #f5c242;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>Allotrope</h1>
<h2>ðŸŽ¡ Roue 100% gagnante</h2>

<canvas id="wheelCanvas" width="320" height="320"></canvas>

<button id="spinBtn">Lancer la roue</button>

<div id="result" style="margin-top:20px; font-size:1.2rem"></div>

<script>
/* ðŸ”’ 1 â€” Anti-rejeu */
if (localStorage.getItem("hasPlayed") === "true") {
  document.getElementById("spinBtn").disabled = true;
  document.getElementById("spinBtn").innerText = "Vous avez dÃ©jÃ  jouÃ© ðŸŽ";
}

/* ðŸ”’ 2 â€” Avis obligatoire */
document.getElementById("spinBtn").addEventListener("click", () => {
  if (!localStorage.getItem("hasLeftReview")) {
    window.location.href = "avis_allotrope.html";
    return;
  }
  spinWheel();
});

/* ðŸŽ¡ 3 â€” Configuration de la roue */
const canvas = document.getElementById("wheelCanvas");
const ctx = canvas.getContext("2d");
const size = canvas.width;
const radius = size / 2;

const prizes = [
  { label: "Tiramisu", weight: 10 },
  { label: "Panna cotta", weight: 25 },
  { label: "Cocktail du moment", weight: 4 },
  { label: "Vin 12 cl", weight: 10 },
  { label: "BiÃ¨re 25 cl", weight: 10 },
  { label: "-10% sur la note", weight: 1 },
  { label: "Shot offert", weight: 40 }
];

const colors = ["#f5c242","#ff8c42","#e05d5d","#5fb49c","#499f68","#ffc857","#9c6db0"];

const sliceAngle = (2 * Math.PI) / prizes.length;
let currentAngle = 0;

function drawWheel(angle=0) {
  ctx.clearRect(0,0,size,size);
  ctx.save();
  ctx.translate(radius,radius);
  ctx.rotate(angle);

  for (let i=0; i<prizes.length; i++){
    const start = i*sliceAngle;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.arc(0,0,radius,start,start+sliceAngle);
    ctx.fillStyle = colors[i];
    ctx.fill();

    ctx.save();
    ctx.rotate(start + sliceAngle/2);
    ctx.translate(radius*0.65,0);
    ctx.rotate(Math.PI/2);
    ctx.fillStyle="#111";
    ctx.font="12px system-ui";
    ctx.fillText(prizes[i].label,-40,0);
    ctx.restore();
  }
  ctx.restore();
}
drawWheel();

/* ðŸŽ¯ Tirage pondÃ©rÃ© */
function pickPrizeIndex(){
  const total = prizes.reduce((a,b)=>a+b.weight,0);
  let r = Math.random()*total;
  for(let i=0;i<prizes.length;i++){
    if(r < prizes[i].weight) return i;
    r -= prizes[i].weight;
  }
}

/* ðŸŽ¡ Animation de la roue */
function spinWheel(){
  const index = pickPrizeIndex();
  const finalAngle = (Math.PI*3/2) - (index*sliceAngle + sliceAngle/2) + 2*Math.PI*5;

  const duration = 4000;
  const start = performance.now();

  function animate(t){
    const elapsed = t - start;
    const progress = Math.min(elapsed/duration, 1);
    const eased = 1 - Math.pow(1-progress, 3);
    currentAngle = eased * finalAngle;
    drawWheel(currentAngle);

    if(progress < 1) requestAnimationFrame(animate);
    else finalize(index);
  }
  requestAnimationFrame(animate);
}

/* ðŸŽ Affichage du gain */
function finalize(index){
  const prize = prizes[index].label;

  localStorage.setItem("hasPlayed","true");

  const resultDiv = document.getElementById("result");
  const qrLink = "https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=" + encodeURIComponent(prize);

  resultDiv.innerHTML =
    "Vous avez gagnÃ© : <span class='highlight'>" + prize +
    "</span> ðŸŽ‰<br><br><img src='" + qrLink + "'>";
}
</script>

</body>
</html>
